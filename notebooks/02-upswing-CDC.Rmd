---
title: "Comparing surge definition to CDC"
author: "Quang Nguyen"
date: "Last compiled on `r format(Sys.time(), '%Y-%m-%d')`"
output: 
    html_document:
        keep_md: yes
        toc: true
        toc_float: true
        code_folding: hide
    github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data pre-loading and processing  

```{r, message=FALSE, warning=FALSE}
library(here)
library(ggforce)
library(covidcast)
library(epiprocess)
library(tidyverse)
library(ggsci)
library(tsibble)
library(patchwork)
here::i_am(path = "notebooks/02-upswing-CDC.Rmd")
source(here("R", "utils.R"))
# (settings <- get_settings(start_date = "2020-06-01", end_date = "2022-03-01"))
```

Loading CDC Rt estimates  

```{r cdc_load}
cdc_rt <- read_csv(file = here("data", "cdc_rt.csv")) %>% select(-1)
cdc_gr <- read_csv(file = here("data", "cdc_gr.csv")) %>% select(-1)

start_date <- as.character(min(cdc_rt$date[cdc_rt$version == "v254"]))
end_date <- as.character(max(cdc_rt$date[cdc_rt$version == "v254"]))
h <- 4
surge_thresh <- 0.5
min_inc <- 20


head(cdc_rt)
head(cdc_gr)

```

```{r}

print(paste("Computing surge data from", start_date, "to", end_date))
# load data from covid_cast signal
df <- covidcast_signal(data_source = "jhu-csse", 
                          signal = "confirmed_incidence_num", 
                          start_day = start_date, 
                          end_day = end_date, 
                          geo_type = "state",
                          as_of = Sys.Date()) 

# convert to epi-df 
# after temporal operations in tsibble have to back-convert to epi_df
df <- df %>% 
        as_epi_df(geo_type = "state", time_type = "day", as_of = max(.$issue)) %>% 
        select(geo_value, time_value, cases = value) %>% as_tsibble() %>%
        index_by(epiweek = ~yearweek(., week_start = 7)) %>% 
        group_by(geo_value) %>% 
        summarise(cases = sum(cases)) %>% ungroup() %>% 
        as_tibble() %>% dplyr::rename(time_value = epiweek) %>% 
        as_epi_df(geo_type = "state", time_type = "week") %>%
        mutate(geo_value = covidcast::abbr_to_name(geo_value, ignore.case = TRUE))

head(df)
```

# Surge/Downswing computation  

Compute upswing using growth_rate from epiprocess and use approximate labels. For surge classification using growth rate, we use a the weekly percent increase threshold in incidence to be 50% or more assuming that the incident case per week is at least 20. For surge classification using Rt, classified a week as increasing if the Rt had a 95% probability of being greater than or less than 1 (weekly Rt estimates were obtained by averaging daily estimates across the entire week).  

```{r}
df <- df %>% group_by(geo_value) %>% 
    mutate(gr = growth_rate(y = cases, method = "rel_change", h = h) * h) %>% 
    mutate(surge = case_when(
        gr >= surge_thresh & cases >= min_inc ~ "increasing",
        gr <= -surge_thresh & cases >= min_inc ~ "decreasing", 
        TRUE ~ "unclassified"
    ))

rt <- cdc_rt %>% filter(version == "v254") %>% 
    mutate(time_value = yearweek(date, week_start = 7)) %>% 
    rename("geo_value" = "state") %>% 
    group_by(geo_value, time_value) %>% 
    summarise(rt = mean(mean), rt_upper = mean(upper_90), rt_lower = mean(lower_90)) %>% 
    mutate(surge = case_when(
        rt_lower > 1 ~ "increasing", 
        rt_upper < 1 ~ "decreasing",
        TRUE ~ "unclassified"
    ))

head(df)

head(rt)


joint_df <- inner_join(df, rt, by=c("geo_value", "time_value")) %>% 
    pivot_longer(c(surge.x, surge.y), names_to = "source", values_to = "surge") %>%
    mutate(source = if_else(source == "surge.x", "gr", "cdc"))

cols <- c("unclassified" = "#003f5c", "increasing" = "#bc5090", "decreasing" = "#ffa600")
```


# Per state plots {.tabset}

```{r, results='asis'}

for (i in joint_df %>% pull(geo_value) %>% unique()){
    cat('##', i, '\n')
    p1 <- ggplot(joint_df %>% filter(geo_value == i) %>% filter(source == "gr"), 
                 aes(x = time_value, y = cases)) + 
        geom_line(alpha = 0.5) + 
        geom_point(aes(col = surge)) + 
        geom_rect(aes(ymin = 0, ymax = max(cases) + 10, xmin = time_value - 0.5, 
                      xmax = time_value + 0.5, fill = surge), alpha = 0.3) + 
        scale_color_manual(values = cols) + 
        scale_fill_manual(values = cols) + 
        theme_bw() +
        labs(y = "Cases", x = "Epiweek (Year-Week)", col = "Phase classification", fill = "Phase classification", 
             title = str_wrap("Phase classification via growth rate thresholded at 0.5", width = 30))
    p2 <- ggplot(joint_df %>% filter(geo_value == i) %>% filter(source == "cdc"), 
                 aes(x = time_value, y = rt)) +
        geom_point() + 
        geom_line(alpha = 0.5) + 
        geom_point(aes(col = surge)) + 
        geom_ribbon(aes(ymin = rt_lower, ymax = rt_upper), alpha = 0.4) +
        geom_rect(aes(ymin = 0.5, ymax = max(rt) + 0.3, xmin = time_value - 0.5, 
                      xmax = time_value + 0.5, fill = surge), alpha = 0.3) + 
        scale_color_manual(values = cols) + 
        scale_fill_manual(values = cols) + 
        theme_bw() +
        labs(y = "Rt", x = "Epiweek (Year-Week)", col = "Phase classification", fill = "Phase classification", 
             title = str_wrap("Phase classification via 95% CI estimates of Rt", width = 30))

    
    x <- joint_df$gr[joint_df$geo_value == i]
    y <- joint_df$rt[joint_df$geo_value == i]
    
    y <- y[-which(is.na(x))]
    x <- na.omit(x)
    
    p3 <- ggplot(joint_df %>% filter(geo_value == i), 
                 aes(x = rank(gr), y = rank(rt))) + 
        geom_point() + 
        labs(x = "rank(growth_rate)", y = "rank(Rt)", 
             title = paste("Spearman correlation:", round(cor(x,y, method = "spearman"), 3))) +
        theme_bw()
    
    layout <- "
    AAA#
    AAA#
    AAAC
    BBBC
    BBB#
    BBB#
    "
        
    print(p1 + p2 + p3 + plot_layout(guides = "collect", design = layout))
    cat("\n \n")
}

```




